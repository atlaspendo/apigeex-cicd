name: Apigee Proxy Deployment [Reusable Workflow]

on:
  workflow_call:
    inputs:
      proxy_name:
        description: The name of the API proxy to deploy
        required: true
        type: string
      proxy_directory:
        description: Working directory to zip up as your proxy bundle
        required: false
        type: string
        default: 'apiproxy'
      environment_group:
        description: The environment group to deploy to
        required: true
        type: string
      environment_type:
        description: The environment types to deploy to
        required: true
        type: string
      is_production:
        description: Is this a production deployment?
        required: true
        type: boolean
      non_prod_revision:
        description: Revision number from successful non-prod deployment (required for production)
        required: false
        type: string
      runner:
        description: The runner to use for the job
        required: false
        default: 'ubuntu-latest'
        type: string
    secrets:
      apigee_org:
        required: true
      apigee_org_prod:
        required: true
      workload_identity_provider:
        required: true
      workload_identity_provider_prod:
        required: true
      service_account:
        required: true
      service_account_prod:
        required: true

permissions:
  contents: read
  id-token: write

jobs:

  check_deployment_type:
    runs-on: ${{ inputs.runner }}
    outputs:
      deploy_type: ${{ steps.check.outputs.environment }}
      can_proceed: ${{ steps.check.outputs.proceed }}
    steps:
      - name: Determine Deployment Type
        id: check
        run: |
          if [[ "${{ inputs.environment_group }}" == "prod" || "${{ inputs.environment_type }}" == "prod" ]]; then
            if [[ "${{ inputs.is_production }}" != "true" ]]; then
              echo "‚ùå Error: Production environment selected but is_production flag is not set"
              echo "proceed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            if [[ -z "${{ inputs.non_prod_revision }}" ]]; then
              echo "‚ùå Error: Production deployment requires non_prod_revision"
              echo "proceed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=non-prod" >> $GITHUB_OUTPUT
          fi
          echo "proceed=true" >> $GITHUB_OUTPUT

  Setup_GCP_Authentication:
    needs: [check_deployment_type]
    runs-on: ${{ inputs.runner }}
    outputs:
      access_token: ${{ steps.auth.outputs.access_token }}
    steps:
      - name: Authenticate to Google Cloud
        id: auth
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: ${{ secrets['workload_identity_provider', 'workload_identity_provider_prod'][inputs.is_production] }}
          service_account: ${{ secrets['service_account', 'service_account_prod'][inputs.is_production] }}
          token_format: 'access_token'

  Validate_API_Proxy-ApigeeLint:
    needs: [Setup_GCP_Authentication]
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install apigeelint
        run: npm install -g apigeelint

      - name: Run apigeelint
        run: apigeelint -s ${{ inputs.proxy_directory }} -f table.js

  Build_And_Upload_Proxy:
    needs: [Setup_GCP_Authentication, Validate_API_Proxy-ApigeeLint]
    runs-on: ${{ inputs.runner }}
    outputs:
      latest_revision: ${{ steps.upload.outputs.revision }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        id: auth
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: ${{ secrets['workload_identity_provider', 'workload_identity_provider_prod'][inputs.is_production] }}
          service_account: ${{ secrets['service_account', 'service_account_prod'][inputs.is_production] }}
          token_format: 'access_token'

      - name: Install apigeecli
        run: |
          mkdir -p $HOME/.apigeecli/bin
          curl -L https://raw.githubusercontent.com/apigee/apigeecli/main/downloadLatest.sh | sh -
          echo "$HOME/.apigeecli/bin" >> $GITHUB_PATH
          $HOME/.apigeecli/bin/apigeecli --help

      - name: Create API bundle
        id: create-bundle
        working-directory: ${{ github.workspace }}
        run: |
          create_bundle() {
            local source_dir="$1"
            echo "Creating bundle from: $source_dir"
            mkdir -p temp_bundle
            cp -r "$source_dir" temp_bundle/apiproxy
            cd temp_bundle
            zip -r ../proxy.zip apiproxy
            cd ..
            echo "Zip contents:"
            unzip -l proxy.zip
            rm -rf temp_bundle
          }
          
          if [ -d "${{ inputs.proxy_directory }}" ]; then
            create_bundle "${{ inputs.proxy_directory }}"
          elif [ -d "src/${{ inputs.proxy_directory }}" ]; then
            create_bundle "src/${{ inputs.proxy_directory }}"
          else
            echo "Error: Could not find apiproxy directory"
            exit 1
          fi

      - name: Upload and Get Revision
        id: upload
        env:
          APIGEE_ORG: ${{ secrets['apigee_org', 'apigee_org_prod'][inputs.is_production] }}
          PROXY_NAME: ${{ inputs.proxy_name }}
          ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
        run: |
          echo "Importing API proxy bundle to Apigee organization"
          IMPORT_OUTPUT=$($HOME/.apigeecli/bin/apigeecli apis create bundle -n "$PROXY_NAME" -p proxy.zip \
            --org "$APIGEE_ORG" \
            --token "$ACCESS_TOKEN")
          
          echo "$IMPORT_OUTPUT"
          
          LATEST_REVISION=$(echo "$IMPORT_OUTPUT" | grep -oP '"revision": "\K[^"]+')
          
          if [ -z "$LATEST_REVISION" ]; then
            echo "Failed to get revision number"
            exit 1
          fi
          
          echo "Latest revision: $LATEST_REVISION"
          echo "revision=$LATEST_REVISION" >> $GITHUB_OUTPUT

  Deploy_Proxy_To_Environment:
    needs: [check_deployment_type, Setup_GCP_Authentication, Build_And_Upload_Proxy]
    strategy:
      matrix:
        environment: ${{ fromJSON(needs.check_deployment_type.outputs.environments) }}
      fail-fast: false
      max-parallel: 1
    runs-on: ${{ inputs.runner }}
    environment: ${{ matrix.environment }}
    steps:
      - name: Authenticate to Google Cloud
        id: auth
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: ${{ secrets['workload_identity_provider', 'workload_identity_provider_prod'][inputs.is_production] }}
          service_account: ${{ secrets['service_account', 'service_account_prod'][inputs.is_production] }}
          token_format: 'access_token'

      - name: Install apigeecli
        run: |
          mkdir -p $HOME/.apigeecli/bin
          curl -L https://raw.githubusercontent.com/apigee/apigeecli/main/downloadLatest.sh | sh -
          echo "$HOME/.apigeecli/bin" >> $GITHUB_PATH

      - name: Deploy to Environment
        env:
          APIGEE_ORG: ${{ secrets['apigee_org', 'apigee_org_prod'][inputs.is_production] }}
          APIGEE_ENV: ${{ matrix.environment }}
          PROXY_NAME: ${{ inputs.proxy_name }}
          ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
          LATEST_REVISION: ${{ needs.Build_And_Upload_Proxy.outputs.latest_revision }}
        run: |
          if [ -z "$LATEST_REVISION" ]; then
            echo "Error: LATEST_REVISION is empty. Deployment cannot proceed."
            exit 1
          fi
          
          echo "Deploying proxy '$PROXY_NAME' revision '$LATEST_REVISION' to environment '$APIGEE_ENV'"
          
          $HOME/.apigeecli/bin/apigeecli apis deploy \
            --name "$PROXY_NAME" \
            --org "$APIGEE_ORG" \
            --env "$APIGEE_ENV" \
            --rev "$LATEST_REVISION" \
            --token "$ACCESS_TOKEN" \
            --ovr \
            --wait

  Perform_Revision_Cleanup:
    needs: [Deploy_Proxy_To_Environment]
    if: always()
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Authenticate to Google Cloud
        id: auth
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: ${{ secrets['workload_identity_provider', 'workload_identity_provider_prod'][inputs.is_production] }}
          service_account: ${{ secrets['service_account', 'service_account_prod'][inputs.is_production] }}
          token_format: 'access_token'

      - name: Delete Older Revisions
        env:
          APIGEE_ORG: ${{ secrets['apigee_org', 'apigee_org_prod'][inputs.is_production] }}
          APIGEE_PROXY_NAME: ${{ inputs.proxy_name }}
          ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
        run: |
          REVISIONS=$(curl -s -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://apigee.googleapis.com/v1/organizations/$APIGEE_ORG/apis/$APIGEE_PROXY_NAME/revisions")
          
          readarray -t REVISIONS < <(echo "$REVISIONS" | jq -r '.[]' | sort -n)
          TOTAL_REVISIONS=${#REVISIONS[@]}
          KEEP_COUNT=5
          
          if [ "$TOTAL_REVISIONS" -gt "$KEEP_COUNT" ]; then
            DELETE_COUNT=$((TOTAL_REVISIONS - KEEP_COUNT))
            for ((i=0; i<DELETE_COUNT; i++)); do
              REV="${REVISIONS[$i]}"
              curl -X DELETE -H "Authorization: Bearer $ACCESS_TOKEN" \
                "https://apigee.googleapis.com/v1/organizations/$APIGEE_ORG/apis/$APIGEE_PROXY_NAME/revisions/$REV"
            done
          fi

  Generate_Deployment_Report:
    needs: [Validate_API_Proxy-ApigeeLint, Build_And_Upload_Proxy, Deploy_Proxy_To_Environment, check_deployment_type, Perform_Revision_Cleanup, Setup_GCP_Authentication]
    if: always()
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Generate Deployment Summary
        shell: bash
        run: |
          echo "# üéØ Apigee Proxy Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<sub>**Deployment Time:** $(date '+%d/%m/%Y, %H:%M:%S')</sub>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## üîê Identity & Authentication" >> $GITHUB_STEP_SUMMARY
          echo "| Process | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Workload Identity Federation | $([ "${{ needs.Setup_GCP_Authentication.result }}" == "success" ] && echo "‚úÖ Verified" || echo "‚ùå Failed") | Service Account Authentication |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîç Code Analysis" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|---------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| API Proxy Lint Check | $([ "${{ needs.Validate_API_Proxy-ApigeeLint.result }}" == "success" ] && echo "‚úÖ Passed" || echo "‚ùå Failed") | Policy & Structure Validation |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üì¶ Bundle Operations" >> $GITHUB_STEP_SUMMARY
          echo "| Operation | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Proxy Bundle Creation | $([ "${{ needs.Build_And_Upload_Proxy.result }}" == "success" ] && echo "‚úÖ Created" || echo "‚ùå Failed") | Version: ${{ needs.Build_And_Upload_Proxy.outputs.latest_revision }} |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üöÄ Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status | Health Check |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|---------|--------------|" >> $GITHUB_STEP_SUMMARY
          # Process each environment
          IFS=',' read -ra ENVS <<< "${{ inputs.environment_type }}"
          for env in "${ENVS[@]}"; do
            if [ "${{ inputs.environment_group }}" == "default" ]; then
              ENV_NAME="${env}"
            else
              ENV_NAME="${{ inputs.environment_group }}-${env}"
            fi
            if [ "${{ needs.Deploy_Proxy_To_Environment.result }}" == "success" ]; then
              echo "| \`${ENV_NAME}\` | ‚úÖ ACTIVE | \`OPTIMAL\` |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| \`${ENV_NAME}\` | ‚ùå FAILED | \`CRITICAL\` |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìã Deployment Information" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Proxy | \`${{ inputs.proxy_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Revision | \`${{ needs.Build_And_Upload_Proxy.outputs.latest_revision }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Organization | \`${{ secrets['apigee_org', 'apigee_org_prod'][inputs.is_production] }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Group | \`${{ inputs.environment_group }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environments | \`${{ inputs.environment_type }}\` |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üßπ Cleanup Operations" >> $GITHUB_STEP_SUMMARY
          echo "| Operation | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Old Revision Cleanup | $([ "${{ needs.Perform_Revision_Cleanup.result }}" == "success" ] && echo "‚úÖ Completed" || echo "‚ùå Failed") | Keeping Latest 5 Revisions |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìà Final Status" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.is_production }}" == "true" ]; then
            DEPLOY_RESULT="${{ needs.Deploy_Prod.result }}"
            ENV_TYPE="Production"
          else
            DEPLOY_RESULT="${{ needs.Deploy_Proxy_To_Environment.result }}"
            ENV_TYPE="Non-Production"
          fi

          if [ "$DEPLOY_RESULT" == "success" ]; then
            echo "<table><tr><td><h3>‚ú® Deployment Successfully Completed</h3>" >> $GITHUB_STEP_SUMMARY
            echo "<ul>" >> $GITHUB_STEP_SUMMARY
            echo "<li>Authentication: ‚úÖ Verified</li>" >> $GITHUB_STEP_SUMMARY
            echo "<li>Code Quality: ‚úÖ Standards Met</li>" >> $GITHUB_STEP_SUMMARY
            echo "<li>Bundle: ‚úÖ Created & Uploaded</li>" >> $GITHUB_STEP_SUMMARY
            echo "<li>Deployment: ‚úÖ Successfully Deployed</li>" >> $GITHUB_STEP_SUMMARY
            echo "</ul></td></tr></table>" >> $GITHUB_STEP_SUMMARY
          else
            echo "<table><tr><td><h3>‚ö†Ô∏è Deployment Issues Detected</h3>" >> $GITHUB_STEP_SUMMARY
            echo "<ul>" >> $GITHUB_STEP_SUMMARY
            echo "<li>Authentication: $([ "${{ needs.Setup_GCP_Authentication.result }}" == "success" ] && echo "‚úÖ Passed" || echo "‚ùå Failed")</li>" >> $GITHUB_STEP_SUMMARY
            echo "<li>Code Quality: $([ "${{ needs.Validate_API_Proxy-ApigeeLint.result }}" == "success" ] && echo "‚úÖ Passed" || echo "‚ùå Failed")</li>" >> $GITHUB_STEP_SUMMARY
            echo "<li>Bundle: $([ "${{ needs.Build_And_Upload_Proxy.result }}" == "success" ] && echo "‚úÖ Passed" || echo "‚ùå Failed")</li>" >> $GITHUB_STEP_SUMMARY
            echo "<li>Deployment: $([ "$DEPLOY_RESULT" == "success" ] && echo "‚úÖ Passed" || echo "‚ùå Failed")</li>" >> $GITHUB_STEP_SUMMARY
            echo "</ul></td></tr></table>" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "<sub>Run ID: \`${{ github.run_id }}\` | Generated: $(date '+%H:%M:%S')</sub>" >> $GITHUB_STEP_SUMMARY
